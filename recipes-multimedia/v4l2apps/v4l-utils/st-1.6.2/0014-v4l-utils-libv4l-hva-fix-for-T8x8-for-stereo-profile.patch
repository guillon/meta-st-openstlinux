From 833d3d3463f6cca93177aaac63b019f49f47f477 Mon Sep 17 00:00:00 2001
From: Chetan Nanda <chetan.nanda@st.com>
Date: Tue, 28 Jul 2015 16:34:59 +0530
Subject: [PATCH 14/15] v4l-utils: libv4l-hva: fix for T8x8 for stereo profile

Change-Id: I3a24abc09418878d5573fd9524e5f876df46c729
Reviewed-on: https://gerrit.st.com/34886
Reviewed-by: Chetan NANDA <chetan.nanda@st.com>
Tested-by: Chetan NANDA <chetan.nanda@st.com>
Reviewed-by: Hugues FRUCHET <hugues.fruchet@st.com>
Tested-by: Hugues FRUCHET <hugues.fruchet@st.com>
---
 lib/libv4l-hva/gst/vaapi/gstvaapiencoder_h264.c | 10 +++++++++-
 1 file changed, 9 insertions(+), 1 deletion(-)

diff --git a/lib/libv4l-hva/gst/vaapi/gstvaapiencoder_h264.c b/lib/libv4l-hva/gst/vaapi/gstvaapiencoder_h264.c
index 1878416..6ec6441 100644
--- a/lib/libv4l-hva/gst/vaapi/gstvaapiencoder_h264.c
+++ b/lib/libv4l-hva/gst/vaapi/gstvaapiencoder_h264.c
@@ -1372,11 +1372,19 @@ add_packed_picture_header (GstVaapiEncoderH264 * encoder,
   const VAEncPictureParameterBufferH264 *const pic_param = picture->param;
   guint32 data_bit_size;
   guint8 *data;
+  GstVaapiProfile profile = encoder->profile;
+
+  /* Set High profile for encoding the MVC base view. Otherwise, some
+     traditional decoder cannot recognize MVC profile streams with
+     only the base view in there */
+  if (profile == GST_VAAPI_PROFILE_H264_MULTIVIEW_HIGH ||
+      profile == GST_VAAPI_PROFILE_H264_STEREO_HIGH)
+    profile = GST_VAAPI_PROFILE_H264_HIGH;
 
   gst_bit_writer_init (&bs, 128 * 8);
   WRITE_UINT32 (&bs, 0x00000001, 32);   /* start code */
   bs_write_nal_header (&bs, GST_H264_NAL_REF_IDC_HIGH, GST_H264_NAL_PPS);
-  bs_write_pps (&bs, pic_param, encoder->profile);
+  bs_write_pps (&bs, pic_param, profile);
   g_assert (GST_BIT_WRITER_BIT_SIZE (&bs) % 8 == 0);
   data_bit_size = GST_BIT_WRITER_BIT_SIZE (&bs);
   data = GST_BIT_WRITER_DATA (&bs);
-- 
2.7.4

