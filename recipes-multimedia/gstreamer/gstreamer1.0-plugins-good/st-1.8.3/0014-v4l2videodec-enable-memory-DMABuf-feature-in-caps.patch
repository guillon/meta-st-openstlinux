From abea4795484e20771d873a9bcc395dd8440b2ec4 Mon Sep 17 00:00:00 2001
From: Jean-Christophe Trotin <jean-christophe.trotin@st.com>
Date: Thu, 20 Oct 2016 17:57:56 +0200
Subject: [PATCH 14/23] v4l2videodec: enable memory:DMABuf feature in caps

Change-Id: I49030713441e92c4c7f362fb25b078ddec0c91e5
Reviewed-on: https://gerrit.st.com/59408
Tested-by: Jean Christophe TROTIN <jean-christophe.trotin@st.com>
Reviewed-by: Jean Christophe TROTIN <jean-christophe.trotin@st.com>
---
 sys/v4l2/gstv4l2videodec.c | 32 +++++++++++++++++++++++++++++++-
 1 file changed, 31 insertions(+), 1 deletion(-)

diff --git a/sys/v4l2/gstv4l2videodec.c b/sys/v4l2/gstv4l2videodec.c
index 59a43cd..cd7daa6 100644
--- a/sys/v4l2/gstv4l2videodec.c
+++ b/sys/v4l2/gstv4l2videodec.c
@@ -34,6 +34,7 @@
 
 #include <string.h>
 #include <gst/gst-i18n-plugin.h>
+#include <gst/allocators/allocators.h>
 
 GST_DEBUG_CATEGORY_STATIC (gst_v4l2_video_dec_debug);
 #define GST_CAT_DEFAULT gst_v4l2_video_dec_debug
@@ -134,6 +135,9 @@ gst_v4l2_video_dec_open (GstVideoDecoder * decoder)
   if (gst_caps_is_empty (self->probed_srccaps))
     goto no_raw_format;
 
+  /* add "video/x-raw(memory:DMABuf)" to the probed src caps */
+  gst_v4l2_object_add_dmabuf_feature_in_caps (self->probed_srccaps);
+
   return TRUE;
 
 no_encoded_format:
@@ -607,6 +611,10 @@ gst_v4l2_video_dec_handle_frame (GstVideoDecoder * decoder,
         GST_CAPS_INTERSECT_FIRST);
     gst_caps_unref (acquired_caps);
     gst_caps_unref (available_caps);
+
+    /* add "video/x-raw(memory:DMABuf)" to the filter */
+    gst_v4l2_object_add_dmabuf_feature_in_caps (filter);
+
     caps = gst_pad_peer_query_caps (decoder->srcpad, filter);
     gst_caps_unref (filter);
 
@@ -626,11 +634,29 @@ gst_v4l2_video_dec_handle_frame (GstVideoDecoder * decoder,
       gst_video_info_from_caps (&info, caps);
     else
       gst_v4l2_clear_error (&error);
-    gst_caps_unref (caps);
 
     output_state = gst_video_decoder_set_output_state (decoder,
         info.finfo->format, info.width, info.height, self->input_state);
 
+    if (output_state->caps == NULL) {
+      GstCapsFeatures *features;
+
+      output_state->caps = gst_video_info_to_caps (&output_state->info);
+
+      /* if the memory:SystemMemory feature is not set for the chosen caps,
+       * set the memory:DMABuf feature for the output state caps */
+      features = gst_caps_get_features (caps, 0);
+      if (!gst_caps_features_is_equal (features,
+              GST_CAPS_FEATURES_MEMORY_SYSTEM_MEMORY)) {
+        features = gst_caps_get_features (output_state->caps, 0);
+        gst_caps_features_remove (features,
+            GST_CAPS_FEATURE_MEMORY_SYSTEM_MEMORY);
+        gst_caps_features_add (features, GST_CAPS_FEATURE_MEMORY_DMABUF);
+      }
+    }
+
+    gst_caps_unref (caps);
+
     /* Copy the rest of the information, there might be more in the future */
     output_state->info.interlace_mode = info.interlace_mode;
     gst_video_codec_state_unref (output_state);
@@ -1012,6 +1038,10 @@ gst_v4l2_video_dec_register (GstPlugin * plugin, const gchar * basename,
 
   cdata = g_new0 (GstV4l2VideoDecCData, 1);
   cdata->device = g_strdup (device_path);
+
+  /* add "video/x-raw(memory:DMABuf)" to the src caps */
+  gst_v4l2_object_add_dmabuf_feature_in_caps (src_caps);
+
   cdata->sink_caps = gst_caps_ref (sink_caps);
   cdata->src_caps = gst_caps_ref (src_caps);
 
-- 
2.7.4

