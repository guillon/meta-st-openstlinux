From 2afe848af697eff917d9cfb4855e69a019afead9 Mon Sep 17 00:00:00 2001
From: Hugues Fruchet <hugues.fruchet@st.com>
Date: Thu, 12 Jan 2017 16:02:15 +0100
Subject: [PATCH 25/25] v4l2: fix missing v4l2_calls indirection

Change-Id: Ief2d493e9bc858787f4b18781788113dbc927f35
Reviewed-on: https://gerrit.st.com/63442
Reviewed-by: Hugues FRUCHET <hugues.fruchet@st.com>
Tested-by: Hugues FRUCHET <hugues.fruchet@st.com>
---
 sys/v4l2/gstv4l2.c      | 11 ++++++-----
 sys/v4l2/gstv4l2radio.c |  2 +-
 2 files changed, 7 insertions(+), 6 deletions(-)

diff --git a/sys/v4l2/gstv4l2.c b/sys/v4l2/gstv4l2.c
index 83fcc98..4e1ffb1 100644
--- a/sys/v4l2/gstv4l2.c
+++ b/sys/v4l2/gstv4l2.c
@@ -40,6 +40,7 @@
 #include <unistd.h>
 
 #include "ext/videodev2.h"
+#include "v4l2_calls.h"
 #include "v4l2-utils.h"
 
 #include "gstv4l2object.h"
@@ -75,7 +76,7 @@ gst_v4l2_probe_template_caps (const gchar * device, gint video_fd,
     format.index = n;
     format.type = type;
 
-    if (ioctl (video_fd, VIDIOC_ENUM_FMT, &format) < 0)
+    if (v4l2_ioctl (video_fd, VIDIOC_ENUM_FMT, &format) < 0)
       break;                    /* end of enumeration */
 
     GST_LOG ("index:       %u", format.index);
@@ -127,9 +128,9 @@ gst_v4l2_probe_and_register (GstPlugin * plugin)
     gchar *basename;
 
     if (video_fd >= 0)
-      close (video_fd);
+      v4l2_close (video_fd);
 
-    video_fd = open (it->device_path, O_RDWR | O_CLOEXEC);
+    video_fd = v4l2_open (it->device_path, O_RDWR | O_CLOEXEC);
 
     if (video_fd == -1) {
       GST_DEBUG ("Failed to open %s: %s", it->device_path, g_strerror (errno));
@@ -138,7 +139,7 @@ gst_v4l2_probe_and_register (GstPlugin * plugin)
 
     memset (&vcap, 0, sizeof (vcap));
 
-    if (ioctl (video_fd, VIDIOC_QUERYCAP, &vcap) < 0) {
+    if (v4l2_ioctl (video_fd, VIDIOC_QUERYCAP, &vcap) < 0) {
       GST_DEBUG ("Failed to get device capabilities: %s", g_strerror (errno));
       continue;
     }
@@ -194,7 +195,7 @@ gst_v4l2_probe_and_register (GstPlugin * plugin)
   }
 
   if (video_fd >= 0)
-    close (video_fd);
+    v4l2_close (video_fd);
 
   gst_v4l2_iterator_free (it);
 
diff --git a/sys/v4l2/gstv4l2radio.c b/sys/v4l2/gstv4l2radio.c
index 7a6463c..e9b573b 100644
--- a/sys/v4l2/gstv4l2radio.c
+++ b/sys/v4l2/gstv4l2radio.c
@@ -222,7 +222,7 @@ gst_v4l2radio_set_mute_on (GstV4l2Radio * radio, gboolean on)
 
   GST_DEBUG_OBJECT (radio, "radio fd: %d", radio->v4l2object->video_fd);
 
-  res = ioctl (radio->v4l2object->video_fd, VIDIOC_S_CTRL, &vctrl);
+  res = v4l2_ioctl (radio->v4l2object->video_fd, VIDIOC_S_CTRL, &vctrl);
   GST_DEBUG_OBJECT (radio, "mute state change result: %d", res);
   if (res < 0)
     goto freq_failed;
-- 
2.7.4

