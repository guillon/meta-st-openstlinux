From 42fe709488f023e8f11fff24e65a998ca1ed0dae Mon Sep 17 00:00:00 2001
From: Jean-Christophe Trotin <jean-christophe.trotin@st.com>
Date: Fri, 21 Oct 2016 11:10:00 +0200
Subject: [PATCH 20/23] v4l2transform: enable memory:DMABuf feature in caps

Change-Id: Ia2dc5b64da148afe2ef5591e613b7a473aac6c6b
Reviewed-on: https://gerrit.st.com/58625
Tested-by: Jean Christophe TROTIN <jean-christophe.trotin@st.com>
Reviewed-by: Jean Christophe TROTIN <jean-christophe.trotin@st.com>
---
 sys/v4l2/gstv4l2transform.c | 12 +++++++++---
 1 file changed, 9 insertions(+), 3 deletions(-)

diff --git a/sys/v4l2/gstv4l2transform.c b/sys/v4l2/gstv4l2transform.c
index 3090ff6..52a29f4 100644
--- a/sys/v4l2/gstv4l2transform.c
+++ b/sys/v4l2/gstv4l2transform.c
@@ -130,12 +130,16 @@ gst_v4l2_transform_open (GstV4l2Transform * self)
   if (gst_caps_is_empty (self->probed_sinkcaps))
     goto no_input_format;
 
+  gst_v4l2_object_add_dmabuf_feature_in_caps (self->probed_sinkcaps);
+
   self->probed_srccaps = gst_v4l2_object_get_caps (self->v4l2capture,
       gst_v4l2_object_get_raw_caps ());
 
   if (gst_caps_is_empty (self->probed_srccaps))
     goto no_output_format;
 
+  gst_v4l2_object_add_dmabuf_feature_in_caps (self->probed_srccaps);
+
   return TRUE;
 
 no_input_format:
@@ -374,9 +378,7 @@ gst_v4l2_transform_caps_remove_format_info (GstCaps * caps)
 
     st = gst_structure_copy (st);
     /* Only remove format info for the cases when we can actually convert */
-    if (!gst_caps_features_is_any (f)
-        && gst_caps_features_is_equal (f,
-            GST_CAPS_FEATURES_MEMORY_SYSTEM_MEMORY))
+    if (!gst_caps_features_is_any (f))
       gst_structure_remove_fields (st, "format", "colorimetry", "chroma-site",
           "width", "height", "pixel-aspect-ratio", NULL);
 
@@ -1172,6 +1174,10 @@ gst_v4l2_transform_register (GstPlugin * plugin, const gchar * basename,
 
   cdata = g_new0 (GstV4l2TransformCData, 1);
   cdata->device = g_strdup (device_path);
+
+  gst_v4l2_object_add_dmabuf_feature_in_caps (sink_caps);
+  gst_v4l2_object_add_dmabuf_feature_in_caps (src_caps);
+
   cdata->sink_caps = gst_caps_ref (sink_caps);
   cdata->src_caps = gst_caps_ref (src_caps);
 
-- 
2.7.4

