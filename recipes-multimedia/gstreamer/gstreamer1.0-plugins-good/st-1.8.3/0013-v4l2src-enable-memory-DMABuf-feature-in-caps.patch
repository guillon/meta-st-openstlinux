From 30f1d3996c9dfbb69b732d27924311c307998d2e Mon Sep 17 00:00:00 2001
From: Vincent Abriou <vincent.abriou@st.com>
Date: Mon, 24 Oct 2016 11:30:07 +0200
Subject: [PATCH 13/23] v4l2src: enable memory:DMABuf feature in caps

Change-Id: I2a018a663611c3f8fa43f195c23a63e0dfa60e2c
Signed-off-by: Vincent Abriou <vincent.abriou@st.com>
Reviewed-on: https://gerrit.st.com/59316
---
 sys/v4l2/gstv4l2src.c | 17 ++++++++++++++---
 1 file changed, 14 insertions(+), 3 deletions(-)

diff --git a/sys/v4l2/gstv4l2src.c b/sys/v4l2/gstv4l2src.c
index a6d34b1..4017632 100644
--- a/sys/v4l2/gstv4l2src.c
+++ b/sys/v4l2/gstv4l2src.c
@@ -48,6 +48,7 @@
 #include <sys/time.h>
 #include <unistd.h>
 
+#include <gst/allocators/allocators.h>
 #include <gst/video/gstvideometa.h>
 #include <gst/video/gstvideopool.h>
 
@@ -128,6 +129,7 @@ gst_v4l2src_class_init (GstV4l2SrcClass * klass)
   GstElementClass *element_class;
   GstBaseSrcClass *basesrc_class;
   GstPushSrcClass *pushsrc_class;
+  GstCaps *caps = NULL;
 
   gobject_class = G_OBJECT_CLASS (klass);
   element_class = GST_ELEMENT_CLASS (klass);
@@ -168,10 +170,14 @@ gst_v4l2src_class_init (GstV4l2SrcClass * klass)
       "Edgard Lima <edgard.lima@indt.org.br>, "
       "Stefan Kost <ensonic@users.sf.net>");
 
+  /* Add video/x-raw(memory:DMABuf) to the caps */
+  caps = gst_v4l2_object_get_all_caps ();
+  caps = gst_caps_make_writable (caps);
+  gst_v4l2_object_add_dmabuf_feature_in_caps (caps);
+
   gst_element_class_add_pad_template
       (element_class,
-      gst_pad_template_new ("src", GST_PAD_SRC, GST_PAD_ALWAYS,
-          gst_v4l2_object_get_all_caps ()));
+      gst_pad_template_new ("src", GST_PAD_SRC, GST_PAD_ALWAYS, caps));
 
   basesrc_class->get_caps = GST_DEBUG_FUNCPTR (gst_v4l2src_get_caps);
   basesrc_class->set_caps = GST_DEBUG_FUNCPTR (gst_v4l2src_set_caps);
@@ -411,6 +417,7 @@ gst_v4l2src_get_caps (GstBaseSrc * src, GstCaps * filter)
 {
   GstV4l2Src *v4l2src;
   GstV4l2Object *obj;
+  GstCaps *caps;
 
   v4l2src = GST_V4L2SRC (src);
   obj = v4l2src->v4l2object;
@@ -419,7 +426,11 @@ gst_v4l2src_get_caps (GstBaseSrc * src, GstCaps * filter)
     return gst_pad_get_pad_template_caps (GST_BASE_SRC_PAD (v4l2src));
   }
 
-  return gst_v4l2_object_get_caps (obj, filter);
+  caps = gst_v4l2_object_get_caps (obj, filter);
+  caps = gst_caps_make_writable (caps);
+  gst_v4l2_object_add_dmabuf_feature_in_caps (caps);
+
+  return caps;
 }
 
 static gboolean
-- 
2.7.4

