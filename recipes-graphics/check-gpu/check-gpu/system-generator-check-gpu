#!/bin/sh -
#===============================================================================
#
#          FILE: system-generator-check-gpu
#
#   DESCRIPTION: The goal are to detect if the gpu are present/loaded or not 
#  ORGANIZATION: STMicroelectronics
#     COPYRIGHT: Copyright (C) 2018, STMicroelectronics - All Rights Reserved
#===============================================================================

check_dt_status() {
gcnano_dir=$(ls /proc/device-tree/soc/ | grep gcnano)
if [ ! -d /proc/device-tree/soc/$gcnano_dir ];
then
    echo "Gcnano in /proc/device-tree/soc/ is not available" > /dev/kmsg
    exit 1
else
    if $(grep -q "okay" /proc/device-tree/soc/$gcnano_dir/status); then
        gcnano_status="okay"
    fi
fi
}

check_load_module() {
galcore_module=$(cat /proc/modules | grep  galcore)
}

check_devices() {
galcore_device=$(ls -l /dev/ | grep galcore)
}

#
# Main
#
gcnano_status="disabled"
galcore_module=""
galcore_device=""

check_dt_status
check_load_module
check_devices

if [ "$gcnano_status" = "okay" ] && [ -n "$galcore_module" ] && [ -n "$galcore_device" ];
then
    echo "Gcnano is present and activated" > /dev/kmsg
else
    if [ -f /etc/default/weston ] && $(grep -q "Autogenerated" /etc/default/weston) ;
    then
        echo "Weston already configured on pixman" > /dev/kmsg
    else
        echo "Configure weston on pixman" > /dev/kmsg
        echo "#Autogenerated" > /etc/default/weston
        echo "OPTARGS=--use-pixman" >> /etc/default/weston
    fi
fi
