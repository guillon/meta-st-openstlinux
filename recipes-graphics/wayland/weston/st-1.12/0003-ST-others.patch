From bc8c1f65a5e8e86ce37a2790c3f09adc79b58117 Mon Sep 17 00:00:00 2001
From: Christophe Priouzeau <christophe.priouzeau@st.com>
Date: Fri, 3 Feb 2017 13:21:58 +0100
Subject: [PATCH 3/4] ST others

---
 shared/cairo-util.h                   | 10 +++-------
 shared/frame.c                        | 12 ++++++------
 shared/platform.h                     |  2 +-
 shared/string-helpers.h               |  1 +
 tools/zunitc/src/zuc_junit_reporter.c |  8 +++++++-
 xwayland/window-manager.c             |  5 +++--
 6 files changed, 21 insertions(+), 17 deletions(-)

diff --git a/shared/cairo-util.h b/shared/cairo-util.h
index 4fee087..84cf005 100644
--- a/shared/cairo-util.h
+++ b/shared/cairo-util.h
@@ -29,6 +29,7 @@
 #include <stdint.h>
 #include <cairo.h>
 
+#include <wayland-client.h>
 #include <wayland-util.h>
 
 void
@@ -123,11 +124,6 @@ enum {
 	FRAME_BUTTON_ALL = 0x7
 };
 
-enum frame_button_state {
-	FRAME_BUTTON_RELEASED = 0,
-	FRAME_BUTTON_PRESSED = 1
-};
-
 struct frame *
 frame_create(struct theme *t, int32_t width, int32_t height, uint32_t buttons,
 	     const char *title);
@@ -208,7 +204,7 @@ frame_pointer_leave(struct frame *frame, void *pointer);
  */
 enum theme_location
 frame_pointer_button(struct frame *frame, void *pointer,
-		     uint32_t button, enum frame_button_state state);
+		     uint32_t button, enum wl_pointer_button_state state);
 
 enum theme_location
 frame_touch_down(struct frame *frame, void *data, int32_t id, int x, int y);
@@ -218,7 +214,7 @@ frame_touch_up(struct frame *frame, void *data, int32_t id);
 
 enum theme_location
 frame_double_click(struct frame *frame, void *pointer,
-		   uint32_t button, enum frame_button_state state);
+		   uint32_t button, enum wl_pointer_button_state state);
 
 void
 frame_double_touch_down(struct frame *frame, void *data, int32_t id,
diff --git a/shared/frame.c b/shared/frame.c
index 9cd44c6..eb0cd77 100644
--- a/shared/frame.c
+++ b/shared/frame.c
@@ -745,7 +745,7 @@ frame_pointer_leave(struct frame *frame, void *data)
 
 enum theme_location
 frame_pointer_button(struct frame *frame, void *data,
-		     uint32_t btn, enum frame_button_state state)
+		     uint32_t btn, enum wl_pointer_button_state state)
 {
 	struct frame_pointer *pointer = frame_pointer_get(frame, data);
 	struct frame_pointer_button *button;
@@ -759,7 +759,7 @@ frame_pointer_button(struct frame *frame, void *data,
 				      frame->flags & FRAME_FLAG_MAXIMIZED ?
 				      THEME_FRAME_MAXIMIZED : 0);
 
-	if (state == FRAME_BUTTON_PRESSED) {
+	if (state == WL_POINTER_BUTTON_STATE_PRESSED) {
 		button = malloc(sizeof *button);
 		if (!button)
 			return location;
@@ -770,7 +770,7 @@ frame_pointer_button(struct frame *frame, void *data,
 		wl_list_insert(&pointer->down_buttons, &button->link);
 
 		frame_pointer_button_press(frame, pointer, button);
-	} else if (state == FRAME_BUTTON_RELEASED) {
+	} else if (state == WL_POINTER_BUTTON_STATE_RELEASED) {
 		button = NULL;
 		wl_list_for_each(button, &pointer->down_buttons, link)
 			if (button->button == btn)
@@ -844,7 +844,7 @@ frame_touch_up(struct frame *frame, void *data, int32_t id)
 
 enum theme_location
 frame_double_click(struct frame *frame, void *data,
-		   uint32_t btn, enum frame_button_state state)
+		   uint32_t btn, enum wl_pointer_button_state state)
 {
 	struct frame_pointer *pointer = frame_pointer_get(frame, data);
 	struct frame_button *button;
@@ -860,12 +860,12 @@ frame_double_click(struct frame *frame, void *data,
 	if (location != THEME_LOCATION_TITLEBAR || btn != BTN_LEFT)
 		return location;
 
-	if (state == FRAME_BUTTON_PRESSED) {
+	if (state == WL_POINTER_BUTTON_STATE_PRESSED) {
 		if (button)
 			frame_button_press(button);
 		else
 			frame->status |= FRAME_STATUS_MAXIMIZE;
-	} else if (state == FRAME_BUTTON_RELEASED) {
+	} else if (state == WL_POINTER_BUTTON_STATE_RELEASED) {
 		if (button)
 			frame_button_release(button);
 	}
diff --git a/shared/platform.h b/shared/platform.h
index 1eb96fd..30db1a6 100644
--- a/shared/platform.h
+++ b/shared/platform.h
@@ -33,9 +33,9 @@
 #include <wayland-egl.h>
 #include <EGL/egl.h>
 #include <EGL/eglext.h>
-#endif
 
 #include "weston-egl-ext.h"
+#endif
 
 #ifdef  __cplusplus
 extern "C" {
diff --git a/shared/string-helpers.h b/shared/string-helpers.h
index 5dc75d6..c8ce449 100644
--- a/shared/string-helpers.h
+++ b/shared/string-helpers.h
@@ -28,6 +28,7 @@
 
 #include <stdbool.h>
 #include <stdlib.h>
+#include <stdint.h>
 #include <errno.h>
 #include <assert.h>
 
diff --git a/tools/zunitc/src/zuc_junit_reporter.c b/tools/zunitc/src/zuc_junit_reporter.c
index 369f035..5c6b762 100644
--- a/tools/zunitc/src/zuc_junit_reporter.c
+++ b/tools/zunitc/src/zuc_junit_reporter.c
@@ -53,6 +53,12 @@
 
 #define ISO_8601_FORMAT "%Y-%m-%dT%H:%M:%SZ"
 
+#if LIBXML_VERSION >= 20904
+#define STRPRINTF_CAST
+#else
+#define STRPRINTF_CAST BAD_CAST
+#endif
+
 /**
  * Internal data.
  */
@@ -68,7 +74,7 @@ static void
 set_attribute(xmlNodePtr node, const char *name, int value)
 {
 	xmlChar scratch[MAX_64BIT_STRLEN + 1] = {};
-	xmlStrPrintf(scratch, sizeof(scratch), BAD_CAST "%d", value);
+	xmlStrPrintf(scratch, sizeof(scratch), STRPRINTF_CAST "%d", value);
 	xmlSetProp(node, BAD_CAST name, scratch);
 }
 
diff --git a/xwayland/window-manager.c b/xwayland/window-manager.c
index 4fab602..0e26d7c 100644
--- a/xwayland/window-manager.c
+++ b/xwayland/window-manager.c
@@ -1759,7 +1759,7 @@ weston_wm_handle_button(struct weston_wm *wm, xcb_generic_event_t *event)
 	struct weston_pointer *pointer;
 	struct weston_wm_window *window;
 	enum theme_location location;
-	enum frame_button_state button_state;
+	enum wl_pointer_button_state button_state;
 	uint32_t button_id;
 
 	wm_log("XCB_BUTTON_%s (detail %d)\n",
@@ -1777,7 +1777,8 @@ weston_wm_handle_button(struct weston_wm *wm, xcb_generic_event_t *event)
 	pointer = weston_seat_get_pointer(seat);
 
 	button_state = button->response_type == XCB_BUTTON_PRESS ?
-		FRAME_BUTTON_PRESSED : FRAME_BUTTON_RELEASED;
+		WL_POINTER_BUTTON_STATE_PRESSED :
+		WL_POINTER_BUTTON_STATE_RELEASED;
 	button_id = button->detail == 1 ? BTN_LEFT : BTN_RIGHT;
 
 	/* Make sure we're looking at the right location.  The frame
-- 
2.7.4

